<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Voice â†’ (KO)ì„¤ëª… & (EN)í”„ë¡¬í”„íŠ¸ â†’ Image</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --orange:#ff8a00; --pink:#ff9acb; --blue:#19b5fe; --divider:#111; --text:#222; --muted:#888; --bg:#fafbfc; }
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR",sans-serif}
    .page{display:grid;grid-template-columns:1fr 6px 1.2fr;min-height:100vh}
    .divider{background:var(--divider)} .left,.right{padding:24px}
    .panel{background:#fff;border:4px solid var(--orange);border-radius:12px;padding:18px}
    .panel h2{margin:0 0 12px;color:var(--orange);font-weight:700;font-size:18px}
    .panel-pink{background:#fff;border:4px solid var(--pink);border-radius:12px;padding:18px;margin-top:32px;min-height:380px;display:flex;flex-direction:column}
    .panel-pink h2{margin:0 0 12px;color:var(--pink);font-weight:700;font-size:18px}
    .ko-box{flex:1;border:2px dashed #bbb;border-radius:8px;color:#d45a9e;padding:16px;line-height:1.6;white-space:pre-wrap}
    .tags{margin-top:10px;display:flex;flex-wrap:wrap;gap:6px}.tag{background:#ffe7f3;color:#bf4c8f;border:1px solid #ffc8e7;border-radius:999px;padding:4px 10px;font-size:12px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}.row+.row{margin-top:8px}
    button,.file{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;background:#222;color:#fff}
    button.secondary{background:#666} button:disabled{opacity:.45;cursor:not-allowed} small{color:var(--muted)}
    .image-panel{background:#fff;border:6px solid var(--blue);border-radius:12px;padding:18px;min-height:calc(100vh - 48px);display:flex;flex-direction:column}
    .image-panel h2{margin:0 0 8px;color:#1aa3e0;font-size:18px;font-weight:700}
    .image-wrap{flex:1;display:grid;place-items:center;border-radius:10px;background:#f5fbff;overflow:hidden}
    .image-wrap img{max-width:100%;height:auto;display:block}
    @media (max-width:980px){.page{grid-template-columns:1fr}.divider{display:none}.image-panel{min-height:auto;margin-top:18px}}
  </style>
</head>
<body>
  <div class="page">
    <div class="left">
      <section class="panel">
        <h2>ë…¹ìŒ / ì—…ë¡œë“œ / ë¯¸ë¦¬ë“£ê¸°</h2>
        <div class="row">
          <button id="btnRec">â— ë…¹ìŒ ì‹œì‘</button>
          <button id="btnStop" class="secondary" disabled>â–  ë…¹ìŒ ì •ì§€</button>
          <small id="recStatus">ëŒ€ê¸° ì¤‘</small>
        </div>
        <div class="row" style="width:100%;margin-top:8px;">
          <audio id="previewAudio" controls style="width:100%;display:none;"></audio>
        </div>
        <div class="row" style="width:100%;margin-top:8px;">
          <input type="file" id="file" class="file" accept="audio/*" />
          <button id="btnPreview" class="secondary" disabled>â–· ë¯¸ë¦¬ ë“£ê¸°</button>
          <button id="btnAnalyze" disabled>ë¶„ì„í•˜ê¸°</button>
        </div>
      </section>

      <section class="panel-pink">
        <h2>ë¶„ì„ ê²°ê³¼</h2>
        <div id="koBox" class="ko-box">ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
        <div class="tags" id="tags"></div>
        <div class="row" style="margin-top:12px;">
          <button id="btnToImage" disabled>ì´ë¯¸ì§€ ìƒì„±</button>
        </div>
      </section>
    </div>

    <div class="divider"></div>

    <div class="right">
      <section class="image-panel">
        <h2>ì´ë¯¸ì§€</h2>
        <div class="image-wrap" id="imageWrap">
          <span style="color:#8ad2ff">ì•„ì§ ìƒì„±ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</span>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ==== ìƒíƒœ ====
    let mediaRecorder, chunks=[];
    let latestBlob=null, latestFile=null;
    let lastObjectUrl=null, pendingRevoke=null;
    let currentStream=null;

    const $ = id => document.getElementById(id);
    const setStatus = t => $('recStatus').textContent = t;
    const audioEl = () => $('previewAudio');

    // --- ì•ˆì „í•œ revoke íƒ€ì´ë° ê´€ë¦¬ ---
    function safelyRevoke(url){
      if (!url) return;
      try { URL.revokeObjectURL(url); } catch(e){}
    }

    function setPreviewUrl(url){
      const a = audioEl();

      // ìŠ¤íŠ¸ë¦¼ ë¯¸ë¦¬ë“£ê¸° í•´ì œ
      if (a.srcObject) a.srcObject = null;

      // ì´ì „ revoke ì˜ˆì•½ ì·¨ì†Œ
      if (pendingRevoke){ clearTimeout(pendingRevoke); pendingRevoke=null; }

      const prev = lastObjectUrl;

      if (url){
        a.src = url;
        a.style.display = 'block';

        // ìƒˆ URL ë¡œë“œë˜ë©´ ê·¸ë•Œ ì´ì „ ê²ƒ revoke (ì¦‰ì‹œ í•´ì œ ê¸ˆì§€!)
        const onLoaded = () => {
          if (prev && prev !== url) safelyRevoke(prev);
          a.removeEventListener('loadeddata', onLoaded);
        };
        a.addEventListener('loadeddata', onLoaded);

        if (typeof url === 'string' && url.startsWith('blob:')) {
          lastObjectUrl = url;      // blobë§Œ ì¶”ì 
        } else {
          lastObjectUrl = null;     // http(s) ë“±ì€ ì¶”ì  ë¶ˆí•„ìš”
        }

        a.play?.().catch(()=>{});   // ìë™ì¬ìƒ ì •ì±… ê±¸ë¦¬ë©´ â–¶ ëˆŒëŸ¬ì£¼ì„¸ìš”
      } else {
        a.removeAttribute('src');
        a.style.display = 'none';
        // ì ê¹ ë”œë ˆì´ í›„ ì´ì „ blob ì •ë¦¬ (ë¸Œë¼ìš°ì €ê°€ ì‚¬ìš© ì¤‘ì¼ ìˆ˜ ìˆìŒ)
        if (prev){
          pendingRevoke = setTimeout(()=>{ safelyRevoke(prev); pendingRevoke=null; }, 1500);
        }
        lastObjectUrl = null;
      }
    }

    function setPreviewFromBlob(blob){
      const url = URL.createObjectURL(blob);
      setPreviewUrl(url);
    }
    function setPreviewFromFile(file){
      const url = URL.createObjectURL(file);
      setPreviewUrl(url);
    }

    function showKo(description, ko_explanation, tags=[]){
      $('koBox').textContent = ko_explanation || description || 'ì„¤ëª…ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.';
      const c = $('tags'); c.innerHTML='';
      (tags||[]).forEach(t=>{
        const s=document.createElement('span'); s.className='tag'; s.textContent=t; c.appendChild(s);
      });
      $('btnToImage').disabled = !(window.lastResult?.en_prompt);
    }
    function showImage(url){
      const wrap=$('imageWrap'); wrap.innerHTML='';
      const img=document.createElement('img'); img.src=url; img.alt='result';
      wrap.appendChild(img);
    }

    async function analyze(){
      const fd = new FormData();
      if (latestFile){
        fd.append('file', latestFile);
      } else if (latestBlob){
        fd.append('file', new File([latestBlob], 'record.webm', {type:'audio/webm'}));
      } else {
        alert('ë¶„ì„í•  ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤.'); return;
      }
      setStatus('ë¶„ì„ ì¤‘â€¦');
      try{
        const res = await fetch('/analyze_api', { method:'POST', body: fd });
        const data = await res.json();
        if(!data.ok){ alert(data.error || 'ë¶„ì„ ì‹¤íŒ¨'); setStatus('ëŒ€ê¸° ì¤‘'); return; }
        window.lastResult = data;
        showKo(data.description, data.ko_explanation, data.tags||[]);
        setStatus('ëŒ€ê¸° ì¤‘');
        // if (data.preview_url) setPreviewUrl(data.preview_url); // (ì›í•˜ë©´ ë¶„ì„ í›„ ì„œë²„ ì €ì¥ë³¸ìœ¼ë¡œ ì „í™˜)
      }catch(e){ alert('ë¶„ì„ í˜¸ì¶œ ì‹¤íŒ¨'); setStatus('ëŒ€ê¸° ì¤‘'); }
    }

    // ==== ë…¹ìŒ ====
    $('btnRec').onclick = async ()=>{
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      chunks=[]; currentStream=stream;

      const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : 'audio/webm';
      mediaRecorder = new MediaRecorder(stream, { mimeType: mime });

      mediaRecorder.ondataavailable = e => { if (e.data?.size) chunks.push(e.data); };
      mediaRecorder.onstop = ()=>{
        const blob = new Blob(chunks, {type:'audio/webm'});

        latestBlob = blob; latestFile = null;
        setPreviewFromBlob(blob);              // ğŸ”¹ ë…¹ìŒ ì§í›„ ë¯¸ë¦¬ë“£ê¸°
        $('btnPreview').disabled = false;
        $('btnAnalyze').disabled = false;
        setStatus('ë¯¸ë¦¬ë“£ê¸° ê°€ëŠ¥');

        try{ currentStream?.getTracks()?.forEach(t=>t.stop()); }catch(e){}
        currentStream=null;
      };

      mediaRecorder.start();
      setStatus('ë…¹ìŒ ì¤‘â€¦');
      $('btnStop').disabled = false;

      // (ì„ íƒ) ë…¹ìŒ ì¤‘ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
      try{
        const a=audioEl();
        a.srcObject=stream; a.style.display='block';
        a.play?.().catch(()=>{});
      }catch(e){}
    };

    $('btnStop').onclick = ()=>{
      if (mediaRecorder && mediaRecorder.state !== 'inactive'){
        mediaRecorder.stop(); $('btnStop').disabled = true;
      }
    };

    // ==== ì—…ë¡œë“œ â†’ ì¦‰ì‹œ ë¯¸ë¦¬ë“£ê¸° ====
    $('file').addEventListener('change', e=>{
      const f = e.target.files[0];
      latestFile = f || null;
      if (f){
        latestBlob = null;
        setPreviewFromFile(f);                 // ğŸ”¹ ì—…ë¡œë“œ ì¦‰ì‹œ ë¯¸ë¦¬ë“£ê¸°
        $('btnPreview').disabled = false;
        $('btnAnalyze').disabled = false;
        setStatus('ë¯¸ë¦¬ë“£ê¸° ê°€ëŠ¥');
      } else {
        $('btnPreview').disabled = true;
        $('btnAnalyze').disabled = true;
        setPreviewUrl(null);
        setStatus('ëŒ€ê¸° ì¤‘');
      }
    });

    // ==== ë¯¸ë¦¬ë“£ê¸° ë²„íŠ¼ ====
    $('btnPreview').onclick = ()=>{
      if (latestBlob){ setPreviewFromBlob(latestBlob); return; }
      if (latestFile){ setPreviewFromFile(latestFile); return; }
      alert('ë¯¸ë¦¬ ë“¤ì„ ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤.');
    };

    // ==== ë¶„ì„ ë²„íŠ¼ ====
    $('btnAnalyze').onclick = analyze;

    // ==== ì´ë¯¸ì§€ ìƒì„± ====
    $('btnToImage').onclick = async ()=>{
      if(!window.lastResult?.en_prompt){ alert('ë¨¼ì € ë¶„ì„ì„ ì™„ë£Œí•˜ì„¸ìš”.'); return; }
      const r = await fetch('/image/render', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ prompt: window.lastResult.en_prompt, negativePrompt: window.lastResult.negative_prompt||'', width:768, height:768 })
      });
      const j = await r.json();
      if (j?.imageUrl) showImage(j.imageUrl);
    };
  </script>
</body>
</html>
