<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Voice → (KO)설명 & (EN)프롬프트 → Image</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --orange:#ff8a00; --pink:#ff9acb; --blue:#19b5fe; --divider:#111; --text:#222; --muted:#888; --bg:#fafbfc; }
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR",sans-serif}
    .page{display:grid;grid-template-columns:1fr 6px 1.2fr;min-height:100vh}
    .divider{background:var(--divider)} .left,.right{padding:24px}
    .panel{background:#fff;border:4px solid var(--orange);border-radius:12px;padding:18px}
    .panel h2{margin:0 0 12px;color:var(--orange);font-weight:700;font-size:18px}
    .panel-pink{background:#fff;border:4px solid var(--pink);border-radius:12px;padding:18px;margin-top:32px;min-height:380px;display:flex;flex-direction:column}
    .panel-pink h2{margin:0 0 12px;color:var(--pink);font-weight:700;font-size:18px}
    .ko-box{flex:1;border:2px dashed #bbb;border-radius:8px;color:#d45a9e;padding:16px;line-height:1.6;white-space:pre-wrap}
    .tags{margin-top:10px;display:flex;flex-wrap:wrap;gap:6px}.tag{background:#ffe7f3;color:#bf4c8f;border:1px solid #ffc8e7;border-radius:999px;padding:4px 10px;font-size:12px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}.row+.row{margin-top:8px}
    button,.file{appearance:none;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;background:#222;color:#fff}
    button.secondary{background:#666} button:disabled{opacity:.45;cursor:not-allowed} small{color:var(--muted)}
    .image-panel{background:#fff;border:6px solid var(--blue);border-radius:12px;padding:18px;min-height:calc(100vh - 48px);display:flex;flex-direction:column}
    .image-panel h2{margin:0 0 8px;color:#1aa3e0;font-size:18px;font-weight:700}
    .image-wrap{flex:1;display:grid;place-items:center;border-radius:10px;background:#f5fbff;overflow:hidden}
    .image-wrap img{max-width:100%;height:auto;display:block}
    @media (max-width:980px){.page{grid-template-columns:1fr}.divider{display:none}.image-panel{min-height:auto;margin-top:18px}}
  </style>
</head>
<body>
  <div class="page">
    <div class="left">
      <section class="panel">
        <h2>녹음 / 업로드 / 미리듣기</h2>
        <div class="row">
          <button id="btnRec">● 녹음 시작</button>
          <button id="btnStop" class="secondary" disabled>■ 녹음 정지</button>
          <small id="recStatus">대기 중</small>
        </div>
        <div class="row" style="width:100%;margin-top:8px;">
          <audio id="previewAudio" controls style="width:100%;display:none;"></audio>
        </div>
        <div class="row" style="width:100%;margin-top:8px;">
          <input type="file" id="file" class="file" accept="audio/*" />
          <button id="btnPreview" class="secondary" disabled>▷ 미리 듣기</button>
          <button id="btnAnalyze" disabled>분석하기</button>
        </div>
      </section>

      <section class="panel-pink">
        <h2>분석 결과</h2>
        <div id="koBox" class="ko-box">분석 결과가 여기에 표시됩니다.</div>
        <div class="tags" id="tags"></div>
        <div class="row" style="margin-top:12px;">
          <button id="btnToImage" disabled>이미지 생성</button>
        </div>
      </section>
    </div>

    <div class="divider"></div>

    <div class="right">
      <section class="image-panel">
        <h2>이미지</h2>
        <div class="image-wrap" id="imageWrap">
          <span style="color:#8ad2ff">아직 생성된 이미지가 없습니다</span>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ==== 상태 ====
    let mediaRecorder, chunks=[];
    let latestBlob=null, latestFile=null;
    let lastObjectUrl=null, pendingRevoke=null;
    let currentStream=null;

    const $ = id => document.getElementById(id);
    const setStatus = t => $('recStatus').textContent = t;
    const audioEl = () => $('previewAudio');

    // --- 안전한 revoke 타이밍 관리 ---
    function safelyRevoke(url){
      if (!url) return;
      try { URL.revokeObjectURL(url); } catch(e){}
    }

    function setPreviewUrl(url){
      const a = audioEl();

      // 스트림 미리듣기 해제
      if (a.srcObject) a.srcObject = null;

      // 이전 revoke 예약 취소
      if (pendingRevoke){ clearTimeout(pendingRevoke); pendingRevoke=null; }

      const prev = lastObjectUrl;

      if (url){
        a.src = url;
        a.style.display = 'block';

        // 새 URL 로드되면 그때 이전 것 revoke (즉시 해제 금지!)
        const onLoaded = () => {
          if (prev && prev !== url) safelyRevoke(prev);
          a.removeEventListener('loadeddata', onLoaded);
        };
        a.addEventListener('loadeddata', onLoaded);

        if (typeof url === 'string' && url.startsWith('blob:')) {
          lastObjectUrl = url;      // blob만 추적
        } else {
          lastObjectUrl = null;     // http(s) 등은 추적 불필요
        }

        a.play?.().catch(()=>{});   // 자동재생 정책 걸리면 ▶ 눌러주세요
      } else {
        a.removeAttribute('src');
        a.style.display = 'none';
        // 잠깐 딜레이 후 이전 blob 정리 (브라우저가 사용 중일 수 있음)
        if (prev){
          pendingRevoke = setTimeout(()=>{ safelyRevoke(prev); pendingRevoke=null; }, 1500);
        }
        lastObjectUrl = null;
      }
    }

    function setPreviewFromBlob(blob){
      const url = URL.createObjectURL(blob);
      setPreviewUrl(url);
    }
    function setPreviewFromFile(file){
      const url = URL.createObjectURL(file);
      setPreviewUrl(url);
    }

    function showKo(description, ko_explanation, tags=[]){
      $('koBox').textContent = ko_explanation || description || '설명이 비어 있습니다.';
      const c = $('tags'); c.innerHTML='';
      (tags||[]).forEach(t=>{
        const s=document.createElement('span'); s.className='tag'; s.textContent=t; c.appendChild(s);
      });
      $('btnToImage').disabled = !(window.lastResult?.en_prompt);
    }
    function showImage(url){
      const wrap=$('imageWrap'); wrap.innerHTML='';
      const img=document.createElement('img'); img.src=url; img.alt='result';
      wrap.appendChild(img);
    }

    async function analyze(){
      const fd = new FormData();
      if (latestFile){
        fd.append('file', latestFile);
      } else if (latestBlob){
        fd.append('file', new File([latestBlob], 'record.webm', {type:'audio/webm'}));
      } else {
        alert('분석할 음성이 없습니다.'); return;
      }
      setStatus('분석 중…');
      try{
        const res = await fetch('/analyze_api', { method:'POST', body: fd });
        const data = await res.json();
        if(!data.ok){ alert(data.error || '분석 실패'); setStatus('대기 중'); return; }
        window.lastResult = data;
        showKo(data.description, data.ko_explanation, data.tags||[]);
        setStatus('대기 중');
        // if (data.preview_url) setPreviewUrl(data.preview_url); // (원하면 분석 후 서버 저장본으로 전환)
      }catch(e){ alert('분석 호출 실패'); setStatus('대기 중'); }
    }

    // ==== 녹음 ====
    $('btnRec').onclick = async ()=>{
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      chunks=[]; currentStream=stream;

      const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : 'audio/webm';
      mediaRecorder = new MediaRecorder(stream, { mimeType: mime });

      mediaRecorder.ondataavailable = e => { if (e.data?.size) chunks.push(e.data); };
      mediaRecorder.onstop = ()=>{
        const blob = new Blob(chunks, {type:'audio/webm'});

        latestBlob = blob; latestFile = null;
        setPreviewFromBlob(blob);              // 🔹 녹음 직후 미리듣기
        $('btnPreview').disabled = false;
        $('btnAnalyze').disabled = false;
        setStatus('미리듣기 가능');

        try{ currentStream?.getTracks()?.forEach(t=>t.stop()); }catch(e){}
        currentStream=null;
      };

      mediaRecorder.start();
      setStatus('녹음 중…');
      $('btnStop').disabled = false;

      // (선택) 녹음 중 실시간 모니터링
      try{
        const a=audioEl();
        a.srcObject=stream; a.style.display='block';
        a.play?.().catch(()=>{});
      }catch(e){}
    };

    $('btnStop').onclick = ()=>{
      if (mediaRecorder && mediaRecorder.state !== 'inactive'){
        mediaRecorder.stop(); $('btnStop').disabled = true;
      }
    };

    // ==== 업로드 → 즉시 미리듣기 ====
    $('file').addEventListener('change', e=>{
      const f = e.target.files[0];
      latestFile = f || null;
      if (f){
        latestBlob = null;
        setPreviewFromFile(f);                 // 🔹 업로드 즉시 미리듣기
        $('btnPreview').disabled = false;
        $('btnAnalyze').disabled = false;
        setStatus('미리듣기 가능');
      } else {
        $('btnPreview').disabled = true;
        $('btnAnalyze').disabled = true;
        setPreviewUrl(null);
        setStatus('대기 중');
      }
    });

    // ==== 미리듣기 버튼 ====
    $('btnPreview').onclick = ()=>{
      if (latestBlob){ setPreviewFromBlob(latestBlob); return; }
      if (latestFile){ setPreviewFromFile(latestFile); return; }
      alert('미리 들을 음성이 없습니다.');
    };

    // ==== 분석 버튼 ====
    $('btnAnalyze').onclick = analyze;

    // ==== 이미지 생성 ====
    $('btnToImage').onclick = async ()=>{
      if(!window.lastResult?.en_prompt){ alert('먼저 분석을 완료하세요.'); return; }
      const r = await fetch('/image/render', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ prompt: window.lastResult.en_prompt, negativePrompt: window.lastResult.negative_prompt||'', width:768, height:768 })
      });
      const j = await r.json();
      if (j?.imageUrl) showImage(j.imageUrl);
    };
  </script>
</body>
</html>
